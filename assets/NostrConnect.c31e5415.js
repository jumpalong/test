var w=Object.defineProperty;var C=(e,t,n)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var h=(e,t,n)=>(C(e,typeof t!="symbol"?t+"":t,n),n);import{T as u,n as o,a as E}from"./nostr.754d0882.js";import{i as P,j as l,p as N}from"./use.1e6bcf04.js";import{a8 as m,ao as g,ae as A,a9 as _,N as R,a6 as v,ac as z}from"./index.1b90d9b0.js";import{a as y,S}from"./Staff.e039c64f.js";import{g as O,a as q}from"./nostr.1ed837f5.js";const B=y()(()=>({initialization(){this.beltline.onAfterReq(({url:e})=>{this.beltline.getRelayEmiter().once("close",e,({url:t})=>{this.beltline.req(t,this.beltline.getFilters())})})}})),K={...m,duration:1e3*60},T=y()(e=>{var s;const t=`TemporaryUniqueEvent:${e}`,n={set:new Set((s=g(t))!=null?s:void 0),addId(r){this.set.add(r),this.updateSet(this.set)},updateSet:A(r=>{_(t,[...r],K)},1e3)};return{push(r){if(n.set.has(r.id))return S.BREAK;n.addId(r.id)}}});var j=Object.defineProperty,$=Object.getOwnPropertyDescriptor,I=(e,t,n,s)=>{for(var r=s>1?void 0:s?$(t,n):t,a=e.length-1,i;a>=0;a--)(i=e[a])&&(r=(s?i(t,n,r):i(r))||r);return s&&r&&j(t,n,r),r},p=(e,t)=>(n,s)=>t(n,s,e);const f=24133,H=3e4;let d=class{constructor(e,t,n){h(this,"emiter",new v.exports);this.rootEventBeltline=e,this.createEventBeltline=t,this.nostrConnectedSynchronizer=n}createNostrConnectEventLine(e){const t=`createNostrConnectEventLine:${e.pubkey}`;return z(t,()=>this.createEventBeltline.createEventBeltlineReactive().addFilter({["#p"]:[e.pubkey],kinds:[f]}).addStaff(B()).addStaff(N()).addStaff(T(t)).addStaff(this.cleateNostrConnectStaff()).addReadUrl(),{useLocalStorage:!1})}cleateNostrConnectStaff(){const e=this;return y()(()=>({push(t){if(t.pubkey===D())return S.BREAK;e.toPush(t,this.beltline)},feat:{onRequestAuthorization(t){e.emiter.on("requestAuthorization",t)}}}))()}async toPush(e,t){try{const n=await o.nip04.decrypt(e.pubkey,e.content),s=JSON.parse(n),r=s.id;if(!this.nostrConnectedSynchronizer.hasConnected(e.pubkey)&&s.method!=="connect")return;const a=F(e.pubkey,s.method);if(a)this.allow(e,r,s,t);else if(typeof a=="boolean"){this.refuse(e,r,s,t);return}else this.emiter.emit("requestAuthorization",{allow:i=>this.allow(e,r,s,t,i),refuse:i=>this.refuse(e,r,s,t,i),event:e,requistOpt:s})}catch{}}async refuse(e,t,n,s,r){r&&b(e.pubkey,n.method,!1,r);const a={id:t,error:"refuse:The user has rejected your authorization request"},i=await o.nip04.encrypt(e.pubkey,JSON.stringify(a));s.publish({kind:f,content:i,tags:[["p",e.pubkey]]},new Set)}async allow(e,t,n,s,r){r&&b(e.pubkey,n.method,!0,r);let a;try{const c=await this.onRequest({senderPubkey:e.pubkey,...n});a={id:t,result:c}}catch(c){a={id:t,error:c}}const i=await o.nip04.encrypt(e.pubkey,JSON.stringify(a));s.publish({kind:f,content:i,tags:[["p",e.pubkey]]},new Set)}async onRequest(e){E.createChild();const t=e.method;if(t==="describe")return["describe","get_public_key","sign_event","connect","disconnect","delegate","get_relays","nip04_encrypt","nip04_decrypt"];if(t==="get_public_key")return await o.getPublicKey();if(t==="sign_event"){const n=e;return await o.signEvent(...n.params)}else if(t==="connect"){await this.nostrConnectedSynchronizer.connect(e.senderPubkey);return}else if(t==="disconnect"){this.nostrConnectedSynchronizer.disConnect(e.senderPubkey);return}else{if(t==="get_relays")return await o.getRelays();if(t==="nip04_encrypt"){const n=e;return await o.nip04.encrypt(...n.params)}else if(t==="nip04_decrypt"){const n=e;return await o.nip04.decrypt(...n.params)}else throw new Error("")}}};d=I([P(),p(0,l(u.RootEventBeltline)),p(1,l(u.CreateEventBeltline)),p(2,l(u.NostrConnectedSynchronizer))],d);function L(){var t;const e=(t=localStorage.getItem("__temp_prikey"))!=null?t:q();return localStorage.setItem("__temp_prikey",e),e}function D(){return O(L())}const k={...m};function b(e,t,n,s=7*24*3600*1e3){_(`not_asking:${e}:${t}`,n,{...k,duration:s})}function F(e,t){return g(`not_asking:${e}:${t}`,k)}R([]);export{H as C,d as N,L as a,B as c,D as g,f as k};
