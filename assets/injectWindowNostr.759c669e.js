var k=Object.defineProperty;var E=(r,e,t)=>e in r?k(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var i=(r,e,t)=>(E(r,typeof e!="symbol"?e+"":e,t),t);import{T as m,i as w,r as _}from"./nostr.c03670ae.js";import{s as g,N as l,g as A}from"./login.0b8718d8.js";import{g as y,b as S,s as O,c as u}from"./nostr.ad89cf30.js";import{S as I}from"./SynchronizerAbstract.b6083252.js";import{c as K}from"./nostr.0043d5e6.js";import{i as b,j as N}from"./use.b23b6c29.js";import{c as j}from"./NaddrLink.vue_vue_type_script_setup_true_lang.e9edc141.js";import{a as C,k as P,c as F}from"./NostrConnect.ef90b4f4.js";import{a6 as R,bl as q,ac as L,bm as U}from"./index.8f62a545.js";import{N as c}from"./error.469adc75.js";class B{constructor(e){i(this,"pubkey");i(this,"getPrikey");i(this,"nip04");this.getPrikey=()=>{if(!e)throw new Error("Not prikey");return e},e&&(this.pubkey=y(e)),this.nip04=new D(this.getPrikey)}async getPublicKey(){if(!this.pubkey)throw new Error("Not pubkey");return this.pubkey}async getRelays(){return{}}async signEvent(e){let t=Object.assign({kind:1,pubkey:this.getPublicKey(),created_at:Math.floor(Date.now()/1e3),tags:[],content:""},e);return!t.id&&(t.id=S(t)),t.sig=O(e,this.getPrikey()),Promise.resolve(t)}}class D{constructor(e){i(this,"getPrikey");this.getPrikey=e}async encrypt(e,t){return Promise.resolve(u.encrypt(this.getPrikey(),e,t))}async decrypt(e,t){return Promise.resolve(u.decrypt(this.getPrikey(),e,t))}}var M=Object.defineProperty,T=Object.getOwnPropertyDescriptor,J=(r,e,t,s)=>{for(var n=s>1?void 0:s?T(e,t):e,a=r.length-1,o;a>=0;a--)(o=r[a])&&(n=(s?o(e,t,n):o(n))||n);return s&&n&&M(e,t,n),n},$=(r,e)=>(t,s)=>e(t,s,r);const d="prikey";let f=class{constructor(r){this.container=r}loginPrikey(r){localStorage.setItem(d,r),g(l.PrivateKey);const e=new B(r);this.container.rebind(m.NostrApi).toDynamicValue(()=>e),w({nostrApi:e})}registerPrikey(r=K()){this.loginPrikey(r);const e=y(r);return localStorage.setItem("newUserFlag",e),r}logout(){localStorage.removeItem(d),g(l.NotLogin),I.clearAll(),setTimeout(()=>{location.reload()},0)}testAndVerifyNewUser(){const r=localStorage.getItem("newUserFlag"),e=localStorage.getItem("prikey"),t=e&&y(e);return!!(A()===l.PrivateKey&&r&&r===t)}clearNewUserFlag(){localStorage.removeItem("newUserFlag")}};f=J([b(),$(0,N(m.NostrContainer))],f);var x=Object.defineProperty,V=Object.getOwnPropertyDescriptor,v=(r,e,t,s)=>{for(var n=s>1?void 0:s?V(e,t):e,a=r.length-1,o;a>=0;a--)(o=r[a])&&(n=(s?o(e,t,n):o(n))||n);return s&&n&&x(e,t,n),n};let h=class{constructor(r){i(this,"tempPrikey");i(this,"tempPubkey");i(this,"pubkey");i(this,"line");i(this,"emiter");i(this,"nip04");i(this,"createEventBeltline");logger.debug("NostrConnectNostrApiImpl",this);const e=this;this.pubkey=r,this.tempPrikey=C(),this.tempPubkey=y(this.tempPrikey),this.emiter=new R.exports,this.nip04={async encrypt(...t){return await e.request({method:"nip04_encrypt",params:t})},async decrypt(...t){return await e.request({method:"nip04_decrypt",params:t})}}}async connect(){return await this.request({method:"connect",params:[this.pubkey]})}async disconnect(){return await this.request({method:"disconnect",params:[]})}listen(){const r=this;return this.line=this.createEventBeltline.createEventBeltlineReactive().addFilter({authors:[this.pubkey],kinds:[P],["#p"]:[this.tempPubkey]}).addStaff(F()).addStaff({push(e){(async()=>{try{const s=JSON.parse(await u.decrypt(r.tempPrikey,r.pubkey,e.content)),n=s.id;r.emiter.emit(n,s)}catch{}})()}}).addReadUrl()}getLine(){return this.line?this.line:this.listen()}async request(r){return new Promise(async(e,t)=>{const s=q(),n=JSON.stringify({id:s,method:r.method,params:r.params}),a=await u.encrypt(this.tempPrikey,this.pubkey,n),o=j({kind:P,pubkey:this.tempPubkey,content:a,tags:[["p",this.pubkey]]},this.tempPrikey);this.emiter.once(s,p=>{!p||(p.error?t(p.error):e(p.result))}),await this.getLine().publish(o,_.getWriteList())})}async getPublicKey(){return this.pubkey}async getRelays(){return L(`getRelays:${this.pubkey}`,async()=>await this.request({method:"get_relays",params:[]}),{useLocalStorage:!1,cacheError:!1})}async signEvent(r){return await this.request({method:"sign_event",params:[r]})}};v([N(m.CreateEventBeltline)],h.prototype,"createEventBeltline",2);h=v([b()],h);class W{constructor(e){i(this,"getNostrApi");i(this,"nip04");this.getNostrApi=e!=null?e:async()=>({});const t=async()=>{var s;return(s=(await this.getNostrApi()).nip04)!=null?s:{}};this.nip04={async encrypt(...s){const n=await t();if(!n.encrypt)throw new c("Not found encrypt");return n.encrypt(...s)},async decrypt(...s){const n=await t();if(!n.decrypt)throw new c("Not found decrypt");return n.decrypt(...s)}}}async getPublicKey(){const e=await this.getNostrApi();if(!e.getPublicKey)throw new c("Not found getPublicKey");return await e.getPublicKey()}async getRelays(){var t,s;const e=await this.getNostrApi();try{return(s=(t=e.getRelays)==null?void 0:t.call(e))!=null?s:{}}catch{return{}}}async signEvent(e){const t=await this.getNostrApi();if(!t.signEvent)throw new c("Not found signEvent");const s=JSON.parse(JSON.stringify(e));return t.signEvent(s)}}function ie(){w({nostrApi:Y()})}function Y(){return new W(()=>U(async()=>window.nostr?window.nostr:Promise.reject(new c("Not Found Nostr"))))}export{f as L,h as N,d as P,W as a,B as b,Y as c,ie as i};
