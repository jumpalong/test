import{bn as S,bo as v,bp as L,bq as u,br as E,aR as g,bs as C,bt as B,bu as U,bv as R,bw as w,bx as k,by as h,bz as b,bA as F,bB as P,bC as D,bD as T,bE as M,bF as y}from"./index.ddbfeb2e.js";class z extends v{constructor(){super("ContactConfiguration",{contactConfiguration:{},channelConfiguration:new Map})}async getFilters(){const t=await L();return t?[{kinds:[3],authors:[t]}]:[]}async serializeToData(t){const a={},s=u(t.tags);for(const{name:n,pubkey:e,relayUrl:r}of s)a[e]={name:n,pubkey:e,relayUrl:r};const o=new Map,c=E(t.tags);for(const n of c){const e=g.createChild().addFilter({kinds:[41],"#e":[n.eventId]}).addFilter({ids:[n.eventId],kinds:[40]}).addStaff(C()).addStaff(B());e.feat.onHasLatestEvent(r=>{Object.assign(n,r)}),e.addExtends(g),o.set(n.eventId,n)}return{contactConfiguration:a,channelConfiguration:o}}getContactConfiguration(){return this.getData().contactConfiguration}async deserializeToEvent(t,a){const s=t.contactConfiguration,o=Object.entries(s).map(([e,{name:r,relayUrl:f}])=>["p",e,f,r].filter(Boolean)),c=t.channelConfiguration,n=U(Array.from(c.entries(),([e,r])=>r));return R({kind:3,tags:[...o,...n],created_at:a})}getChannelConfiguration(){return this.getData().channelConfiguration}getChannelList(){return Array.from(this.getChannelConfiguration()).map(([t,a])=>a)}follow(t,a,s){if(!t)return;const o=this.getDataAndChange().contactConfiguration,c=o[t]={pubkey:t,name:s!=null?s:"",relayUrl:a!=null?a:""},n=this.toChanged(),e=w(t),r=k((f,l)=>{if(this.isReChange(n)){e.closeReq();return}if(Object.assign(c,f),f.relayUrls&&f.relayUrls.length>0)c.relayUrl=f.relayUrls[0];else{const d=e.getUrlBySubId(l!=null?l:"");d&&(c.relayUrl=d)}});this.save(),e.feat.onHasMetadata(r)}unFollow(t){if(!t)return;const a=this.getData().contactConfiguration;a[t]!==void 0&&(this.toChanged(),delete a[t],this.save())}isFollow(t){return Boolean(this.getData().contactConfiguration[t])}}const A=S(new z);setTimeout(()=>{A.sync()},0);function q(i,t){return h(`getContactListLineByPubkey:${i}`,()=>{const a=b().addFilter({kinds:[3],authors:[i]}).addStaff(C()).addStaff(F()).addStaff(P()).addStaff({feat:{getContactList(){const o=this.beltline.feat.getLatestEvent();return o?u(o.tags):[]}}}).addStaff(D());return(async()=>{a.addRelayUrls(t==null?void 0:t.urls),a.addStaff(y(i)),a.addReadUrl()})(),a},{useLocalStorage:!1})}function x(i,t){return h(`getFollowerLineByPubkey:${i}`,()=>{const a=b({name:"getFollowerLineByPubkey"}).addStaff(T([{kinds:[3],"#p":[i]}],100)).addStaff(M()).addStaff(y(i)).addReadUrl().addRelayUrls(t==null?void 0:t.urls);return a.feat.load(),a},{useLocalStorage:!1,duration:1e5})}export{x as a,A as c,q as g};
