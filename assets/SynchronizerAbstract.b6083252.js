var C=Object.defineProperty;var A=(e,t,a)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var o=(e,t,a)=>(A(e,typeof t!="symbol"?t+"":t,a),a);import{aF as B,bo as R,a7 as K,ak as T,ad as _}from"./index.8f62a545.js";import{g as M}from"./error.469adc75.js";import{T as E,a as v,r as U}from"./nostr.c03670ae.js";import{j as S,i as P,k as D,l as z,m as L}from"./use.b23b6c29.js";var k=Object.defineProperty,F=Object.getOwnPropertyDescriptor,w=(e,t,a,n)=>{for(var s=n>1?void 0:n?F(t,a):t,i=e.length-1,r;i>=0;i--)(r=e[i])&&(s=(n?r(t,a,s):r(s))||s);return n&&s&&k(t,a,s),s};const O=window[Symbol.for("loggerFactory")].create("src/nostr/Synchronizer/abstract/SynchronizerAbstract.ts");var d;let h=(d=class{constructor(e,t){o(this,"name");o(this,"eventMap");o(this,"line",v);o(this,"getRelayConfigurator",()=>U);const a=B(this);return h.list.push(a),this.name=e,this.eventMap=new R(`__key_list:${e}`),a.init(t),a}static syncAll(){for(const e of h.list)e.sync()}static clearAll(){for(const e of h.list)e.clear()}async init(e){await this.readEventMap(),await this.sync(e)}getLine(){return this.line}async createKeyByEvent(e){return await this.createKey(await this.eventToFilter(e))}async readEventMap(){const e=this.eventMap.getMap();for(const[t,a]of e){const n=await this.serializeToData(a),s=this.cacheKeyToKey(t);this.setData(s,n)}}async setLocalEvent(e){const t=await this.createKeyByEvent(e);this.setEvent(t,e)}getEvent(e){return this.eventMap.get(this.createEventCacheKey(e))}setEvent(e,t){this.eventMap.set(this.createEventCacheKey(e),t)}createEventCacheKey(e){return`${this.name}:${e}`}cacheKeyToKey(e){return e.slice(this.name.length+1)}async getChangeAtByFilter(e){const t=await this.createKey(e);return this.getData(t)}getUpdateAt(e){const t=this.getEvent(e);return t?t.created_at:null}async getIsChanged(e){return!!await this.getChangeAt(e)}createEventBeltline(){return this.getLine().createChild()}async sync(e){O.debug(this.name,"sync",e),await K(0);const t=Boolean(e==null?void 0:e.onlyUrl),a=new Set,n=e!=null&&e.onlyUrl?new Set().add(e.onlyUrl):T(new Set,a,this.getRelayConfigurator().getWriteList(),this.getRelayConfigurator().getReadList(),e==null?void 0:e.moreUrls);_(`cache:${this.name}:${JSON.stringify(e)}`,async()=>{let s=await this.getFilters();if(s.length===0)return;const i=this,r=new Set,l=this.createEventBeltline().addFilters(s).addStaff({initialization(){this.beltline.onAfterReq(({subId:c,url:y})=>{this.beltline.getRelayEmiter().once("eose",c,()=>{var f;if(!r.has(y)){const g=i.eventMap.getValues();for(const u of g)i.createEventBeltline().createChild().publish(u,new Set().add(y),{autoPublishToTagR:!1});(f=e==null?void 0:e.onPush)==null||f.call(e,y)}})})},push(c,y,{subId:f,url:g}){var u;!g||(r.add(g),(u=e==null?void 0:e.onEvent)==null||u.call(e,c,g))}}).addStaff(D()).addStaff(z());t||setTimeout(async()=>{if(l.addRelayUrls(n),n.size>0&&!(e!=null&&e.isAutoAddRelayurl))return;const c=await M();!c||l.addStaff(L(c))});const b=new Set;l.addStaff({push:(c,y,{subId:f})=>{this.syncByEvent(c,f,b,l)}}),!(e!=null&&e.onlyUrl)&&l.addExtends(v);const m=this.eventMap.getValues();for(const c of m)v.pushEvent(c)},1e4)}async syncByEvent(e,t,a,n){const s=n.getUrlBySubId(t!=null?t:""),i=await this.createKeyByEvent(e),r=this.getUpdateAt(i);if(!r||e.created_at>r)this.setData(i,await this.serializeToData(e)),this.setLocalEvent(e),n.publish(e,a);else if(e.created_at<r&&s){const l=await this.getEvent(i);l&&n.createChild().publish(l,new Set().add(s),{autoPublishToTagR:!1})}!s||a.add(s)}async save(e){const t=[...await this.getDataKeys()];for(const a of t){if(!await this.getIsChanged(a))continue;const s=await this.getChangeAt(a);if(!s)continue;const i=await this.getData(a);if(!i)continue;const r=await this.deserializeToEvent(i,s);this.setEvent(a,r),await this.changesSaved(a),await this.publish(r,e)}}async publish(e,t){await this.createEventBeltline().publish(e,this.getRelayConfigurator().getWriteList(),t)}clear(){this.eventMap.clear()}},o(d,"list",[]),d);w([S(E.RootEventBeltline)],h.prototype,"line",2);w([S(E.RelayConfiguratorFactory)],h.prototype,"getRelayConfigurator",2);h=w([P()],h);export{h as S};
