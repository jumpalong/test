var g=Object.defineProperty;var f=(o,a,t)=>a in o?g(o,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[a]=t;var l=(o,a,t)=>(f(o,typeof a!="symbol"?a+"":a,t),t);import{ar as p,ac as m}from"./index.8f62a545.js";import{g as d}from"./error.469adc75.js";import{b as w}from"./NaddrLink.vue_vue_type_script_setup_true_lang.e9edc141.js";import{o as h}from"./use.b23b6c29.js";import{S as k}from"./SynchronizerAbstract.b6083252.js";class B extends k{constructor(){super(...arguments);l(this,"map",new Map)}async addData(t,e){this.map.set(t,{data:e,changeAt:null}),this.toChanged(t)}async setData(t,e){this.map.set(t,{data:e,changeAt:null})}async getData(t){var e,s;return(s=(e=this.map.get(t))==null?void 0:e.data)!=null?s:null}async toChanged(t){const e=this.map.get(t);!e||(e.changeAt=p())}async getChangeAt(t){const e=this.map.get(t);return e?e.changeAt:null}async changesSaved(t){const e=this.map.get(t);!e||(e.changeAt=null)}async getDataKeys(){return this.map.keys()}}class D extends B{async eventToFilter(a){var e;const t=h("d",a.tags);return[{kinds:[a.kind],authors:[a.pubkey],["#d"]:[(e=t==null?void 0:t[1])!=null?e:""]}]}async createKey(a){var r,n,y;const t=a[0];if(!t)return"";const e=(r=t.kinds)==null?void 0:r[0],s=(n=t.authors)==null?void 0:n[0],i=(y=t["#d"])==null?void 0:y[0];return await this.createKeyByAddressPointer({kind:e!=null?e:-1,pubkey:s!=null?s:"",identifier:i})}async addDataByAddressPointer(a,t){await this.addData(await this.createKeyByAddressPointer(a),t)}async createKeyByAddressPointer(a){return`${a.kind}:${a.pubkey}:${a.identifier}`}}const c=30001;class z extends D{constructor(){super("CategorizedBookmarksSynchronizer")}async getFilters(){const a=await d();return a?[{kinds:[c],authors:[a]}]:[]}async serializeToData(a){var s;const t=h("d",a.tags);await this.createKeyByEvent(a);const e={map:new Map,name:(s=t==null?void 0:t[1])!=null?s:"",size:0};for(const[i,r]of a.tags){if(!i&&!r)continue;let n=e.map.get(i);n||(n=new Set,e.map.set(i,n)),n.add(r),e.size++}return e}async deserializeToEvent(a,t){const e=[["d",a.name]];for(const[s,i]of a.map)for(const r of i)e.push([String(s),r]);return w({kind:c,created_at:t,tags:e})}createTag(a){var e;const t=a.kind;if(t>=3e4&&t<39999){const s=h("d",a.tags);return["a",`${a.kind}:${a.pubkey}:${(e=s==null?void 0:s[1])!=null?e:""}`]}else return["e",a.id]}async addCollectByEvent(a,t){await this.addCollect(a,...this.createTag(t))}async hasTag(a,t,e){const s=await d();if(!s)return;const i=await this.createKeyByAddressPointer({kind:c,pubkey:s,identifier:a});let r=await this.getData(i);return r?this.toHasByData(r,t,e):!1}async hasByEvent(a,t){this.createTag(t);const e=await d();if(!e)return;const s=await this.createKeyByAddressPointer({kind:c,pubkey:e,identifier:a});let i=await this.getData(s);return i?this.hasByData(t,i):!1}hasByData(a,t){const[e,s]=this.createTag(a);return this.toHasByData(t,e,s)}toHasByData(a,t,e){const s=a.map.get(t);return s?s.has(e):!1}async addCollect(a,t,e){var y,u;const s=await d();if(!s)return;const i=await this.createKeyByAddressPointer({kind:c,pubkey:s,identifier:a});let r=(y=await this.getData(i))!=null?y:{map:new Map,name:a,size:0};if(this.toHasByData(r,t,e))return;let n=(u=r.map.get(t))!=null?u:new Set;n.add(e),r.size++,r.map.set(t,n),await this.setData(i,r),await this.toChanged(i),await this.save()}async deleteCollectByEvent(a,t){await this.deleteCollect(a,...this.createTag(t))}async deleteCollect(a,t,e){const s=await d();if(!s)return;const i=await this.createKeyByAddressPointer({kind:c,pubkey:s,identifier:a});let r=await this.getData(i);if(!r||!this.toHasByData(r,t,e))return;let n=r.map.get(t);n||(n=new Set),n.delete(e),r.size--,r.map.set(t,n),await this.setData(i,r),await this.toChanged(i),await this.save()}values(){return this.map.values()}getList(){return[...this.values()].map(a=>a.data)}async getCollect(a){const t=await d();if(!t)return;const e=await this.createKeyByAddressPointer({kind:c,pubkey:t,identifier:a});return await this.getData(e)}}function P(){return m("getCategorizedBookmarksSynchronizer",()=>new z,{useLocalStorage:!1})}export{P as g};
