var C=Object.defineProperty;var M=(t,n,e)=>n in t?C(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var h=(t,n,e)=>(M(t,typeof n!="symbol"?n+"":n,e),e);import{bG as U,bH as g,by as u,bz as y,bs as E,bt as k,bA as R,bB as B,bC as w,bI as S,bD as m,bJ as v,bE as L,bK as F,bL as T,bM as A,bN as p,bn as z,bO as D,ay as H,br as P,bv as q,bx as x,bP as o,bQ as O,bR as G,bS as j}from"./index.243f7ff1.js";const J=U()(t=>({initialization(){const n=g.channelMetadataEventMap.get(t);n&&this.beltline.pushEvent(n),this.beltline.feat.onHasLatestEvent(e=>{g.channelMetadataEventMap.set(t,e)})}}));function K(t){return u(`getChannelMetadataBeltlineByChannelId:${t}`,()=>{const n=y({describe:"getChannelMetadataBeltlineByChannelId"}).addFilter({ids:[t],kinds:[40]}).addFilter({kinds:[41],"#e":[t]}).addStaff(E()).addStaff(k()).addStaff(R()).addStaff(B()).addStaff(J(t)).addStaff(w());return n.feat.withEvent()||n.addStaff(S(t)).addReadUrl(),n},{useMemoryCache:!0,useLocalStorage:!1})}function Q(t,n){return u(`etChannelMessageBeltline:${t}`,()=>{const e=y({describe:"getChannelMessageBeltline"}).addStaff(m([{kinds:[42],"#e":[t]}])).addStaff(v()).addStaff(L()).addStaff(F()).addStaff(T()).addStaff(A()).addStaffOfSortByCreateAt();return setTimeout(()=>{e.addExtends(e.createChild().addRelayUrls(n==null?void 0:n.urls).onAddRelayUrlsAfter(a=>{e.addRelayUrls(a)}).addFilter({ids:[t],kinds:[40]}).addFilter({kinds:[41],"#e":[t]}).addFilter({kinds:[42],"#e":[t],since:p()}).addStaff(S(t)).addReadUrl()),e.feat.firstLoad()},0),e},{useLocalStorage:!1})}function V(){return u("getFollowChannelConfiguration",()=>{const t=z(new N);return setTimeout(()=>{t.sync()}),t},{useLocalStorage:!1})}class N extends D{constructor(){super("follower-channel",new Map);h(this,"identifier","follower-channel");h(this,"kind",30001)}async getAddressPointers(){const e=await H.getPublicKey();return[{identifier:this.identifier,kind:this.kind,pubkey:e}]}async serializeToData(e){const a=new Map,s=P(e.tags);for(const i of s){const{eventId:l,relay:d,marker:r}=i;this.getData();const c={channelMeta:{relayUrls:[d]},channelId:l,relayUrls:new Set};a.get(l)||this.reqMetadata(l,c),a.set(l,c)}return a}async deserializeToEvent(e,a){const s=[];s.push(["d",this.identifier]);for(const[i,l]of e.entries()){const d=l.channelMeta.relayUrls;if(d){const r=d[0];if(r){s.push(["e",i,r]);continue}}s.push(["e",i])}return q({kind:this.kind,tags:s})}hasJoin(e){return this.getData().has(e)}setChannelmetadata(e,a){const s=this.getData().get(e);s&&(s.channelMeta=a)}joinChannel(e,a){var r;if(!e)return;const s=this.getData();if(s.get(e))return;const l=this.toChanged(),d={channelId:e,channelMeta:(r=a==null?void 0:a.channelMetadata)!=null?r:{},relayUrls:new Set};a!=null&&a.channelMetadata||this.reqMetadata(e,d,l),s.set(e,d),this.save()}reqMetadata(e,a,s){const i=K(e),l=x((r,c)=>{var f;if(s&&this.isReChange(s)){i.closeReq();return}Object.assign(a.channelMeta,r),o(a.relayUrls,(f=a.channelMeta.relayUrls)!=null?f:[])},3e3);i.feat.onHasMetadata(l),O(e).feat.onHasEventOnce(r=>{const c=r.pubkey;a.creator=c,a.event=r;const f=G(r.tags);o(a.relayUrls,f),j(c).feat.onHasReadWriteList(b=>{o(a.relayUrls,b.writeUrl),o(a.relayUrls,b.readUrl)})})}leaveChannel(e){if(!e)return;const a=this.getData();!a.has(e)||(this.toChanged(),a.delete(e),this.save())}}export{K as a,Q as b,V as g};
